#!/usr/bin/env node
/**
 * Automated Supabase Setup for Portfoliosis
 *
 * This script automates the Supabase setup process:
 * 1. Prompts for API credentials
 * 2. Creates .env.local file
 * 3. Runs database migration
 * 4. Verifies connection
 * 5. Tests authentication
 *
 * Usage: node scripts/setup-supabase.js
 */

const fs = require('fs').promises;
const path = require('path');
const { createInterface } = require('readline');

// ANSI color codes
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  red: '\x1b[31m',
  cyan: '\x1b[36m',
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function logStep(step, message) {
  log(`\n[${step}/6] ${message}`, 'cyan');
}

function logSuccess(message) {
  log(`âœ… ${message}`, 'green');
}

function logError(message) {
  log(`âŒ ${message}`, 'red');
}

function logInfo(message) {
  log(`â„¹ï¸  ${message}`, 'blue');
}

// Create readline interface for user input
function createPrompt() {
  return createInterface({
    input: process.stdin,
    output: process.stdout,
  });
}

// Ask a question and get user input
function question(rl, query) {
  return new Promise((resolve) => {
    rl.question(`${colors.yellow}${query}${colors.reset}`, (answer) => {
      resolve(answer.trim());
    });
  });
}

// Validate URL format
function isValidUrl(url) {
  try {
    const parsed = new URL(url);
    return parsed.protocol === 'https:' && parsed.hostname.includes('supabase');
  } catch {
    return false;
  }
}

// Validate API key format
function isValidApiKey(key) {
  return key && key.length > 20 && key.startsWith('eyJ');
}

/**
 * Step 1: Get Supabase credentials from user
 */
async function getCredentials(rl) {
  logStep(1, 'Collecting Supabase Credentials');

  log('\nğŸ“ You need to get these from your Supabase dashboard:', 'bright');
  log('   1. Go to https://supabase.com/dashboard');
  log('   2. Select your project (or create one)');
  log('   3. Go to: Settings > API');
  log('   4. Copy the values below\n');

  let supabaseUrl = '';
  let supabaseAnonKey = '';
  let supabaseServiceKey = '';

  // Get Supabase URL
  while (!isValidUrl(supabaseUrl)) {
    supabaseUrl = await question(rl, 'Supabase URL (https://xxxxx.supabase.co): ');
    if (!isValidUrl(supabaseUrl)) {
      logError('Invalid URL format. Must be https://xxxxx.supabase.co');
    }
  }

  // Get Anon Key
  while (!isValidApiKey(supabaseAnonKey)) {
    supabaseAnonKey = await question(rl, 'Supabase Anon Key (starts with eyJ...): ');
    if (!isValidApiKey(supabaseAnonKey)) {
      logError('Invalid anon key format. Should start with "eyJ" and be quite long.');
    }
  }

  // Get Service Role Key
  while (!isValidApiKey(supabaseServiceKey)) {
    supabaseServiceKey = await question(rl, 'Supabase Service Role Key (starts with eyJ...): ');
    if (!isValidApiKey(supabaseServiceKey)) {
      logError('Invalid service role key format. Should start with "eyJ" and be quite long.');
    }
  }

  logSuccess('Credentials collected!');

  return {
    supabaseUrl,
    supabaseAnonKey,
    supabaseServiceKey,
  };
}

/**
 * Step 2: Create .env.local file
 */
async function createEnvFile(credentials) {
  logStep(2, 'Creating .env.local file');

  const envPath = path.join(__dirname, '..', '.env.local');

  const envContent = `# Portfoliosis Environment Configuration
# Generated by setup-supabase.js on ${new Date().toISOString()}

# App Configuration
NEXT_PUBLIC_APP_URL=http://localhost:3000
NODE_ENV=development

# Database - Supabase
NEXT_PUBLIC_SUPABASE_URL=${credentials.supabaseUrl}
NEXT_PUBLIC_SUPABASE_ANON_KEY=${credentials.supabaseAnonKey}
SUPABASE_SERVICE_ROLE_KEY=${credentials.supabaseServiceKey}

# AI Models (Optional - for Phase 2)
# OPENAI_API_KEY=your_openai_api_key_here
# ANTHROPIC_API_KEY=your_anthropic_api_key_here
# GOOGLE_AI_API_KEY=your_google_ai_api_key_here

# OAuth Providers (Optional)
# LINKEDIN_CLIENT_ID=your_linkedin_client_id_here
# LINKEDIN_CLIENT_SECRET=your_linkedin_client_secret_here
# GITHUB_CLIENT_ID=your_github_client_id_here
# GITHUB_CLIENT_SECRET=your_github_client_secret_here

# Deployment Platforms (Optional - for Phase 5)
# VERCEL_TOKEN=your_vercel_token_here
# NETLIFY_TOKEN=your_netlify_token_here
# GITHUB_TOKEN=your_github_token_here
`;

  await fs.writeFile(envPath, envContent, 'utf8');
  logSuccess('.env.local file created!');
  logInfo(`Location: ${envPath}`);
}

/**
 * Step 3: Test Supabase connection
 */
async function testConnection(credentials) {
  logStep(3, 'Testing Supabase Connection');

  try {
    const response = await fetch(`${credentials.supabaseUrl}/rest/v1/`, {
      headers: {
        'apikey': credentials.supabaseAnonKey,
        'Authorization': `Bearer ${credentials.supabaseAnonKey}`,
      },
    });

    if (response.ok || response.status === 404) {
      // 404 is expected for root endpoint
      logSuccess('Connection successful!');
      return true;
    } else {
      logError(`Connection failed with status: ${response.status}`);
      return false;
    }
  } catch (error) {
    logError(`Connection error: ${error.message}`);
    return false;
  }
}

/**
 * Step 4: Run database migration
 */
async function runMigration(credentials) {
  logStep(4, 'Running Database Migration');

  const migrationPath = path.join(__dirname, '..', 'supabase', 'migrations', '20260111_initial_schema.sql');

  try {
    const migrationSQL = await fs.readFile(migrationPath, 'utf8');

    logInfo('Executing migration SQL...');

    const response = await fetch(`${credentials.supabaseUrl}/rest/v1/rpc/exec_sql`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': credentials.supabaseServiceKey,
        'Authorization': `Bearer ${credentials.supabaseServiceKey}`,
      },
      body: JSON.stringify({ query: migrationSQL }),
    });

    if (response.ok) {
      logSuccess('Migration completed!');
      return true;
    } else {
      // Migration via API might not work, provide manual instructions
      logError('Automatic migration failed. Please run migration manually:');
      log('\nğŸ“‹ Manual Migration Steps:', 'yellow');
      log('   1. Go to your Supabase dashboard');
      log('   2. Click "SQL Editor" in the left sidebar');
      log('   3. Click "New query"');
      log('   4. Copy the entire contents of:');
      log(`      ${migrationPath}`, 'cyan');
      log('   5. Paste into the SQL Editor');
      log('   6. Click "Run"\n');

      const rl = createPrompt();
      const confirmed = await question(rl, 'Have you run the migration manually? (yes/no): ');
      rl.close();

      return confirmed.toLowerCase() === 'yes' || confirmed.toLowerCase() === 'y';
    }
  } catch (error) {
    logError(`Migration error: ${error.message}`);
    return false;
  }
}

/**
 * Step 5: Verify database tables
 */
async function verifyTables(credentials) {
  logStep(5, 'Verifying Database Tables');

  const tables = ['portfolios', 'ai_jobs', 'portfolio_versions', 'templates', 'portfolio_analytics'];

  try {
    for (const table of tables) {
      const response = await fetch(`${credentials.supabaseUrl}/rest/v1/${table}?limit=0`, {
        headers: {
          'apikey': credentials.supabaseAnonKey,
          'Authorization': `Bearer ${credentials.supabaseAnonKey}`,
        },
      });

      if (response.ok) {
        logSuccess(`Table '${table}' exists`);
      } else {
        logError(`Table '${table}' not found`);
        return false;
      }
    }

    logSuccess('All tables verified!');
    return true;
  } catch (error) {
    logError(`Verification error: ${error.message}`);
    return false;
  }
}

/**
 * Step 6: Final summary and next steps
 */
function showSummary() {
  logStep(6, 'Setup Complete! ğŸ‰');

  log('\nâœ… Supabase is configured and ready!', 'green');
  log('\nğŸ“‹ What was set up:', 'bright');
  log('   âœ“ .env.local file created with your credentials');
  log('   âœ“ Database connection verified');
  log('   âœ“ Migration executed (tables created)');
  log('   âœ“ All tables verified\n');

  log('ğŸš€ Next Steps:', 'bright');
  log('   1. Install dependencies:');
  log('      npm install\n', 'cyan');
  log('   2. Start the development server:');
  log('      npm run dev\n', 'cyan');
  log('   3. Open your browser:');
  log('      http://localhost:3000\n', 'cyan');
  log('   4. Test the app:');
  log('      - Create an account (signup)');
  log('      - Log in');
  log('      - Create a portfolio');
  log('      - Upload a resume\n');

  log('ğŸ“š Documentation:', 'bright');
  log('   - Setup guide: SETUP_INSTRUCTIONS.md');
  log('   - Project summary: PORTFOLIOSIS_WEEK_2-3_COMPLETE.md\n');

  log('ğŸ’¡ Pro Tips:', 'bright');
  log('   - Your .env.local is in .gitignore (won\'t be committed)');
  log('   - Keep your Service Role Key secret!');
  log('   - Free tier: 500MB DB, 1GB storage, 50k users\n');
}

/**
 * Main setup flow
 */
async function main() {
  log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'cyan');
  log('â•‘     PORTFOLIOSIS - AUTOMATED SUPABASE SETUP          â•‘', 'cyan');
  log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'cyan');

  const rl = createPrompt();

  try {
    // Step 1: Get credentials
    const credentials = await getCredentials(rl);
    rl.close();

    // Step 2: Create .env.local
    await createEnvFile(credentials);

    // Step 3: Test connection
    const connected = await testConnection(credentials);
    if (!connected) {
      logError('Failed to connect to Supabase. Please check your credentials.');
      process.exit(1);
    }

    // Step 4: Run migration
    const migrated = await runMigration(credentials);
    if (!migrated) {
      logError('Migration failed. Please complete it manually before continuing.');
      process.exit(1);
    }

    // Step 5: Verify tables
    const verified = await verifyTables(credentials);
    if (!verified) {
      logError('Table verification failed. Please check the migration.');
      process.exit(1);
    }

    // Step 6: Show summary
    showSummary();

  } catch (error) {
    logError(`Setup failed: ${error.message}`);
    console.error(error);
    process.exit(1);
  }
}

// Run if executed directly
if (require.main === module) {
  main();
}

module.exports = { main };
